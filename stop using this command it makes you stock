import { Request, Response } from 'express';
import { DepartmentService } from '../services/DepartmentService';
import DepartmentNotificationService from '../services/DepartmentNotificationService';
import { RoleHierarchyService } from '../services/RoleHierarchyService';
import logger from '../utils/logger';

export class DepartmentController {
    private departmentNotificationService: typeof DepartmentNotificationService;
    private roleHierarchyService: RoleHierarchyService;

    constructor(private departmentService: DepartmentService) {
        this.departmentNotificationService = DepartmentNotificationService;
        this.roleHierarchyService = new RoleHierarchyService();
    }

    /**
     * Create a new department
     * POST /api/departments
     */
    async createDepartment(req: Request, res: Response): Promise<void> {
        try {
            const { name, description, team_lead_id, type } = req.body;
            const createdBy = req.user?.employeeId || req.user?.id;
            const userRole = req.user?.role;

            if (!createdBy || !name) {
                res.status(400).json({
                    status: 'error',
                    message: 'Creator ID and department name are required'
                });
                return;
            }

            // Check if user has permission to create departments (HR and above)
            if (!this.roleHierarchyService.hasPermission(userRole, 'hr')) {
                res.status(403).json({
                    status: 'error',
                    message: 'Insufficient permissions to create departments'
                });
                return;
            }

            logger.info('üè¢ [DepartmentController] Create department', {
                name,
                createdBy,
                userRole
            });

            const department = await this.departmentService.createDepartment({
                name,
                description,
                team_lead_id,
                type,
                created_by: createdBy
            });

            res.status(201).json({
                status: 'success',
                message: 'Department created successfully',
                data: { department }
            });
        } catch (error) {
            logger.error('‚ùå [DepartmentController] Create department error', {
                error: (error as Error).message
            });
            res.status(400).json({
                status: 'error',
                message: (error as Error).message
            });
        }
    }

    /**
     * Get all departments
     * GET /api/departments
     */
    async getAllDepartments(req: Request, res: Response): Promise<void> {
        try {
            logger.info('üìã [DepartmentController] Get all departments');

            const departments = await this.departmentService.getAllDepartments();

            res.status(200).json({
                status: 'success',
                data: { departments, count: departments.length }
            });
        } catch (error) {
            logger.error('‚ùå [DepartmentController] Get all departments error', {
                error: (error as Error).message
            });
            res.status(400).json({
                status: 'error',
                message: (error as Error).message
            });
        }
    }

    /**
     * Get department by ID
     * GET /api/departments/:id
     */
    async getDepartment(req: Request, res: Response): Promise<void> {
        try {
            const { id } = req.params;

            if (!id) {
                res.status(400).json({
                    status: 'error',
                    message: 'Department ID is required'
                });
                return;
            }

            const department = await this.departmentService.getDepartmentById(id);

            if (!department) {
                res.status(404).json({
                    status: 'error',
                    message: 'Department not found'
                });
                return;
            }

            res.status(200).json({
                status: 'success',
                data: { department }
            });
        } catch (error) {
            logger.error('‚ùå [DepartmentController] Get department error', {
                error: (error as Error).message
            });
            res.status(400).json({
                status: 'error',
                message: (error as Error).message
            });
        }
    }

    /**
     * Update department
     * PUT /api/departments/:id
     */
    async updateDepartment(req: Request, res: Response): Promise<void> {
        try {
            const { id } = req.params;
            const { name, description, team_lead_id, type } = req.body;
            const userRole = req.user?.role;

            if (!id) {
                res.status(400).json({
                    status: 'error',
                    message: 'Department ID is required'
                });
                return;
            }

            // Check if user has permission to update departments (HR and above)
            if (!this.roleHierarchyService.hasPermission(userRole, 'hr')) {
                res.status(403).json({
                    status: 'error',
                    message: 'Insufficient permissions to update departments'
                });
                return;
            }

            logger.info('üìù [DepartmentController] Update department', { id, userRole });

            const updatedDepartment = await this.departmentService.updateDepartment(id, {
                name,
                description,
                team_lead_id,
                type
            });

            res.status(200).json({
                status: 'success',
                message: 'Department updated successfully',
                data: { department: updatedDepartment }
            });
        } catch (error) {
            logger.error('‚ùå [DepartmentController] Update department error', {
                error: (error as Error).message
            });
            res.status(400).json({
                status: 'error',
                message: (error as Error).message
            });
        }
    }

    /**
     * Delete department
     * DELETE /api/departments/:id
     */
    async deleteDepartment(req: Request, res: Response): Promise<void> {
        try {
            const { id } = req.params;
            const userRole = req.user?.role;

            if (!id) {
                res.status(400).json({
                    status: 'error',
                    message: 'Department ID is required'
                });
                return;
            }

            // Check if user has permission to delete departments (Admin and above)
            if (!this.roleHierarchyService.hasPermission(userRole, 'admin')) {
                res.status(403).json({
                    status: 'error',
                    message: 'Insufficient permissions to delete departments'
                });
                return;
            }

            logger.info('üóëÔ∏è [DepartmentController] Delete department', { id, userRole });

            await this.departmentService.deleteDepartment(id);

            res.status(200).json({
                status: 'success',
                message: 'Department deleted successfully'
            });
        } catch (error) {
            logger.error('‚ùå [DepartmentController] Delete department error', {
                error: (error as Error).message
            });
            res.status(400).json({
                status: 'error',
                message: (error as Error).message
            });
        }
    }

    /**
     * Get department members
     * GET /api/departments/:id/members
     */
    async getDepartmentMembers(req: Request, res: Response): Promise<void> {
        try {
            const { id } = req.params;

            i